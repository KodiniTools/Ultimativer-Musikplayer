<!-- Global Navigation für SSI Include -->
<!-- Einbinden am Anfang des <body>, vor dem Hauptinhalt -->

<style>
/* Reset und Schutz vor bestehenden Styles */
.global-nav * {
    box-sizing: border-box;
}

/* Überschreibung von bestehenden Navigation Styles */
body {
    padding-top: 0 !important;
}

html {
    scroll-padding-top: 0 !important;
}

/* CSS-Variablen für automatische Theme-Anpassung */
.global-nav {
    --nav-bg: transparent;
    --nav-text: #003971;
    --nav-text-hover: #001d3d;
    --nav-bg-hover: rgba(1, 79, 153, 0.08);
    --nav-border: rgba(1, 79, 153, 0.1);
    --nav-shadow: rgba(0, 57, 113, 0.08);
    --dropdown-bg: rgba(255, 255, 255, 0.97);
    --dropdown-border: rgba(1, 79, 153, 0.08);
    --dropdown-shadow: rgba(0, 57, 113, 0.12);
    --accent-color: #014f99;
}

/* Dark Theme Support */
@media (prefers-color-scheme: dark) {
    .global-nav {
        --nav-bg: transparent;
        --nav-text: #F5F4D6;
        --nav-text-hover: #FFFFF0;
        --nav-bg-hover: rgba(255, 255, 255, 0.08);
        --nav-border: rgba(255, 255, 255, 0.1);
        --nav-shadow: rgba(0, 0, 0, 0.3);
        --dropdown-bg: rgba(45, 55, 72, 0.95);
        --dropdown-border: rgba(255, 255, 255, 0.1);
        --dropdown-shadow: rgba(0, 0, 0, 0.25);
        --accent-color: #6366f1;
    }
}

/* Explizite Dark-Class Support */
[data-theme="dark"] .global-nav {
    --nav-bg: transparent;
    --nav-text: #F5F4D6;
    --nav-text-hover: #FFFFF0;
    --nav-bg-hover: rgba(255, 255, 255, 0.08);
    --nav-border: rgba(255, 255, 255, 0.1);
    --nav-shadow: rgba(0, 0, 0, 0.3);
    --dropdown-bg: rgba(45, 55, 72, 0.95);
    --dropdown-border: rgba(255, 255, 255, 0.1);
    --dropdown-shadow: rgba(0, 0, 0, 0.25);
    --accent-color: #6366f1;
}

/* Explizite Light-Class Support (überschreibt prefers-color-scheme: dark) */
[data-theme="light"] .global-nav {
    --nav-bg: transparent;
    --nav-text: #003971;
    --nav-text-hover: #001d3d;
    --nav-bg-hover: rgba(1, 79, 153, 0.08);
    --nav-border: rgba(1, 79, 153, 0.1);
    --nav-shadow: rgba(0, 57, 113, 0.08);
    --dropdown-bg: rgba(255, 255, 255, 0.97);
    --dropdown-border: rgba(1, 79, 153, 0.08);
    --dropdown-shadow: rgba(0, 57, 113, 0.12);
    --accent-color: #014f99;
}

/* Adaptive Navigation Styles - Non-Overlapping */
.global-nav {
    position: relative;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 100;
    background: var(--nav-bg);
    border-bottom: 1px solid var(--nav-border);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Sticky Navigation Option (falls gewünscht, aber nicht overlapping) */
.global-nav.sticky {
    position: sticky;
    top: 0;
}

.global-nav-container {
    max-width: 1200px;
    margin: 0 auto;
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    padding: 0 20px;
    height: 70px;
}

.global-nav-brand {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--nav-text);
    text-decoration: none;
    transition: all 0.3s ease;
    letter-spacing: -0.025em;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.brand-logo-icon {
    height: 24px;
    width: 24px;
    object-fit: contain;
    transition: transform 0.3s ease;
}

.global-nav-brand:hover {
    color: var(--accent-color);
    transform: scale(1.05);
}

.global-nav-links {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.global-nav-item {
    position: relative;
}

.global-nav-link,
.global-nav-dropdown-toggle {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
    color: var(--nav-text);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.95rem;
    border-radius: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    background: transparent;
    border: none;
    white-space: nowrap;
}

.global-nav-link:hover,
.global-nav-dropdown-toggle:hover {
    color: var(--nav-text-hover);
    background: var(--nav-bg-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px var(--nav-shadow);
}

.global-nav-dropdown-arrow {
    font-size: 0.7rem;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0.7;
}

.global-nav-dropdown.active .global-nav-dropdown-arrow {
    transform: rotate(180deg);
}

/* Dropdown Menu - Smart Positioning */
.global-nav-dropdown-menu {
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    min-width: 280px;
    background: var(--dropdown-bg);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid var(--dropdown-border);
    border-radius: 12px;
    box-shadow: 0 10px 40px var(--dropdown-shadow);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px) scale(0.95);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 8px 0;
    z-index: 200;
    max-height: 400px;
    overflow-y: auto;
}

/* Smart Dropdown Positioning - verhindert Überlappung mit Viewport */
.global-nav-dropdown.flip-up .global-nav-dropdown-menu {
    top: auto;
    bottom: calc(100% + 8px);
    transform: translateY(10px) scale(0.95);
}

.global-nav-dropdown.flip-up.active .global-nav-dropdown-menu {
    transform: translateY(0) scale(1);
}

.global-nav-dropdown.flip-right .global-nav-dropdown-menu {
    left: auto;
    right: 0;
}

.global-nav-dropdown.active .global-nav-dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0) scale(1);
}

.global-nav-dropdown-item {
    display: block;
    padding: 12px 20px;
    color: var(--nav-text);
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
    border-left: 3px solid transparent;
}

.global-nav-dropdown-item:hover {
    background: var(--nav-bg-hover);
    color: var(--nav-text-hover);
    border-left-color: var(--accent-color);
    padding-left: 24px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .global-nav-container {
        padding: 0 16px;
        height: 60px;
    }

    .global-nav-brand {
        font-size: 1.3rem;
    }

    .brand-logo-icon {
        height: 22px;
        width: 22px;
    }

    .global-nav-links {
        gap: 4px;
    }

    .global-nav-link,
    .global-nav-dropdown-toggle {
        padding: 8px 12px;
        font-size: 0.9rem;
    }

    .global-nav-dropdown-menu {
        min-width: 240px;
    }
}

@media (max-width: 600px) {
    .global-nav-links {
        flex-wrap: wrap;
        justify-content: flex-end;
    }

    .global-nav-dropdown-menu {
        left: auto;
        right: 0;
        min-width: 200px;
    }
}

/* Fallback für Browser ohne backdrop-filter */
@supports not (backdrop-filter: blur(20px)) {
    .global-nav-dropdown-menu {
        background: var(--dropdown-bg);
    }
}

/* Body Padding entfernt - keine Fixed Navigation mehr */
/* Navigation nimmt natürlichen Platz im Document Flow ein */

/* Schutz vor bestehenden Navigation Styles auf anderen Seiten */
body:not(.custom-nav-page) {
    padding-top: 0 !important;
}

html:not(.custom-nav-page) {
    scroll-padding-top: 0 !important;
}

/* Fallback Reset für problematische Seiten */
.global-nav-reset {
    padding-top: 0 !important;
    margin-top: 0 !important;
}

/* Focus States für Accessibility */
.global-nav-link:focus,
.global-nav-dropdown-toggle:focus {
    outline: 2px solid var(--accent-color);
    outline-offset: 2px;
    border-radius: 8px;
}

.global-nav-dropdown-item:focus {
    background: var(--nav-bg-hover);
    outline: none;
    color: var(--accent-color);
}

/* Language Switcher Styles */
.global-nav-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    justify-self: end;
}

.global-nav-lang-switcher {
    display: flex;
    gap: 0.25rem;
    border: 1px solid var(--nav-border);
    border-radius: 0.5rem;
    padding: 0.25rem;
}

/* Theme Switcher */
.global-nav-theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 38px;
    height: 38px;
    border: 1px solid var(--nav-border);
    border-radius: 0.5rem;
    background: transparent;
    color: var(--nav-text);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1.15rem;
    line-height: 1;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.global-nav-theme-toggle:hover {
    background: var(--nav-bg-hover);
    transform: scale(1.1);
}

.global-nav-theme-toggle .theme-icon-light,
.global-nav-theme-toggle .theme-icon-dark {
    display: none;
}

/* Light-Mode: Mond zeigen (= "zu Dark wechseln") */
.global-nav-theme-toggle .theme-icon-dark {
    display: inline;
}
.global-nav-theme-toggle .theme-icon-light {
    display: none;
}

/* Dark-Mode: Sonne zeigen (= "zu Light wechseln") */
[data-theme="dark"] .global-nav-theme-toggle .theme-icon-dark {
    display: none;
}
[data-theme="dark"] .global-nav-theme-toggle .theme-icon-light {
    display: inline;
}

.global-nav-lang-btn {
    padding: 0.4rem 0.6rem;
    border: none;
    background: transparent;
    border-radius: 0.375rem;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
    font-size: 0.85rem;
    color: var(--nav-text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.global-nav-lang-btn:hover {
    background: var(--nav-bg-hover);
}

.global-nav-lang-btn.active {
    background: var(--accent-color);
    color: #ffffff;
}

[data-theme="dark"] .global-nav-lang-btn.active {
    color: #0C0C10;
}

@media (max-width: 768px) {
    .global-nav-controls {
        gap: 0.25rem;
    }

    .global-nav-lang-switcher {
        margin-left: 0;
    }

    .global-nav-lang-btn {
        padding: 0.3rem 0.5rem;
        font-size: 0.8rem;
    }

    .global-nav-theme-toggle {
        width: 34px;
        height: 34px;
        font-size: 1rem;
    }
}
</style>

<nav class="global-nav" role="navigation" data-nav-i18n-aria="nav.aria" aria-label="Hauptnavigation">
    <div class="global-nav-container">
        <a href="https://kodinitools.com/" class="global-nav-brand">
            <img src="/android-chrome-192x192.png" alt="KodiniTools Logo" class="brand-logo-icon">
            <span>KodiniTools</span>
        </a>

        <div class="global-nav-links">
            <!-- Audiotools Dropdown -->
            <div class="global-nav-item global-nav-dropdown">
                <button class="global-nav-dropdown-toggle" type="button" aria-haspopup="true" aria-expanded="false">
                    <span data-nav-i18n="nav.audiotools">Audiotools</span>
                    <span class="global-nav-dropdown-arrow">&#9660;</span>
                </button>
                <div class="global-nav-dropdown-menu" role="menu">
                    <a href="https://kodinitools.com/mp3konverter/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.mp3converter">MP3 Konverter</a>
                    <a href="https://kodinitools.com/audioequalizer/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.audioequalizer">Interactive Audio Equalizer</a>
                    <a href="https://kodinitools.com/modernermusikplayer/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.modernplayer">Moderner Musikplayer</a>
                    <a href="https://kodinitools.com/ultimativermusikplayer/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.ultimateplayer">Ultimativer Musikplayer</a>
                    <a href="https://kodinitools.com/playlist_generator/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.playlistgen">Audio Playlist Generator</a>
                    <a href="https://kodinitools.com/playlistkonverter/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.playlistconv">Audio Playlist Konverter</a>
                    <a href="https://kodinitools.com/alarmtool/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.alarmtool">Modernes Alarmtool</a>
                    <a href="https://kodinitools.com/audionormalisierer/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.normalizer">Audio Normalizer</a>
                    <a href="https://kodinitools.com/visualizer/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.visualizer">Audio Visualizer</a>
                    <a href="https://kodinitools.com/equaliser19/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.eq19">19 Band Equalizer</a>
                    <a href="https://kodinitools.com/audiokonverter/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.audioconv">Audio Konverter</a>
                </div>
            </div>

            <!-- Bildtools Dropdown -->
            <div class="global-nav-item global-nav-dropdown">
                <button class="global-nav-dropdown-toggle" type="button" aria-haspopup="true" aria-expanded="false">
                    <span data-nav-i18n="nav.imagetools">Bildtools</span>
                    <span class="global-nav-dropdown-arrow">&#9660;</span>
                </button>
                <div class="global-nav-dropdown-menu" role="menu">
                    <a href="https://kodinitools.com/bildkonverter/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.imageconv">Bildkonverter</a>
                    <a href="https://kodinitools.com/bilderseriebearbeiten/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.batchedit">Bildserie bearbeiten</a>
                    <a href="https://kodinitools.com/collagemaker/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.collage">Fotocollage</a>
                </div>
            </div>

            <!-- Tools Dropdown -->
            <div class="global-nav-item global-nav-dropdown">
                <button class="global-nav-dropdown-toggle" type="button" aria-haspopup="true" aria-expanded="false">
                    <span data-nav-i18n="nav.tools">Tools</span>
                    <span class="global-nav-dropdown-arrow">&#9660;</span>
                </button>
                <div class="global-nav-dropdown-menu" role="menu">
                    <a href="https://kodinitools.com/kodini-color-extractor/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.colorextractor">Kodini Farbextraktor</a>
                    <a href="https://kodinitools.com/videokonverter/" class="global-nav-dropdown-item" role="menuitem" data-nav-i18n="nav.videoconv">Videokonverter</a>
                </div>
            </div>

            <div class="global-nav-item">
                <a href="https://kodinitools.com/kontaktformular/" class="global-nav-link" data-nav-i18n="nav.contact">Kontakt</a>
            </div>
        </div>

        <!-- Controls: Theme + Language -->
        <div class="global-nav-controls">
            <button class="global-nav-theme-toggle" type="button" data-nav-i18n-aria="nav.themeAria" data-nav-i18n-title="nav.themeTitle" aria-label="Theme wechseln" title="Hell/Dunkel umschalten">
                <span class="theme-icon-light">&#9728;&#65039;</span>
                <span class="theme-icon-dark">&#127769;</span>
            </button>
            <div class="global-nav-lang-switcher" role="group" data-nav-i18n-aria="nav.langAria" aria-label="Sprache wählen">
                <button class="global-nav-lang-btn" data-lang="de" type="button">DE</button>
                <button class="global-nav-lang-btn" data-lang="en" type="button">EN</button>
            </div>
        </div>
    </div>
</nav>

<script>
// Global Navigation JavaScript mit integrierter i18n
(function() {
    'use strict';

    // ─── Übersetzungen ───
    var navTranslations = {
        de: {
            'nav.aria':           'Hauptnavigation',
            'nav.audiotools':     'Audiotools',
            'nav.mp3converter':   'MP3 Konverter',
            'nav.audioequalizer': 'Interactive Audio Equalizer',
            'nav.modernplayer':   'Moderner Musikplayer',
            'nav.ultimateplayer': 'Ultimativer Musikplayer',
            'nav.playlistgen':    'Audio Playlist Generator',
            'nav.playlistconv':   'Audio Playlist Konverter',
            'nav.alarmtool':      'Modernes Alarmtool',
            'nav.normalizer':     'Audio Normalizer',
            'nav.visualizer':     'Audio Visualizer',
            'nav.eq19':           '19 Band Equalizer',
            'nav.audioconv':      'Audio Konverter',
            'nav.imagetools':     'Bildtools',
            'nav.imageconv':      'Bildkonverter',
            'nav.batchedit':      'Bildserie bearbeiten',
            'nav.collage':        'Fotocollage',
            'nav.tools':          'Tools',
            'nav.colorextractor': 'Kodini Farbextraktor',
            'nav.videoconv':      'Videokonverter',
            'nav.contact':        'Kontakt',
            'nav.themeAria':      'Theme wechseln',
            'nav.themeTitle':     'Hell/Dunkel umschalten',
            'nav.langAria':       'Sprache wählen'
        },
        en: {
            'nav.aria':           'Main Navigation',
            'nav.audiotools':     'Audio Tools',
            'nav.mp3converter':   'MP3 Converter',
            'nav.audioequalizer': 'Interactive Audio Equalizer',
            'nav.modernplayer':   'Modern Music Player',
            'nav.ultimateplayer': 'Ultimate Music Player',
            'nav.playlistgen':    'Audio Playlist Generator',
            'nav.playlistconv':   'Audio Playlist Converter',
            'nav.alarmtool':      'Modern Alarm Tool',
            'nav.normalizer':     'Audio Normalizer',
            'nav.visualizer':     'Audio Visualizer',
            'nav.eq19':           '19 Band Equalizer',
            'nav.audioconv':      'Audio Converter',
            'nav.imagetools':     'Image Tools',
            'nav.imageconv':      'Image Converter',
            'nav.batchedit':      'Batch Image Editor',
            'nav.collage':        'Photo Collage',
            'nav.tools':          'Tools',
            'nav.colorextractor': 'Kodini Color Extractor',
            'nav.videoconv':      'Video Converter',
            'nav.contact':        'Contact',
            'nav.themeAria':      'Toggle theme',
            'nav.themeTitle':     'Switch Light/Dark',
            'nav.langAria':       'Select language'
        }
    };

    // ─── Navigation übersetzen ───
    function translateNav(lang) {
        var t = navTranslations[lang] || navTranslations['de'];
        var nav = document.querySelector('.global-nav');
        if (!nav) return;

        // Texte mit data-nav-i18n aktualisieren
        nav.querySelectorAll('[data-nav-i18n]').forEach(function(el) {
            var key = el.getAttribute('data-nav-i18n');
            if (t[key]) el.textContent = t[key];
        });

        // aria-label mit data-nav-i18n-aria aktualisieren
        document.querySelectorAll('[data-nav-i18n-aria]').forEach(function(el) {
            var key = el.getAttribute('data-nav-i18n-aria');
            if (t[key]) el.setAttribute('aria-label', t[key]);
        });

        // title mit data-nav-i18n-title aktualisieren
        document.querySelectorAll('[data-nav-i18n-title]').forEach(function(el) {
            var key = el.getAttribute('data-nav-i18n-title');
            if (t[key]) el.setAttribute('title', t[key]);
        });
    }

    // Warten auf DOM Load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initGlobalNav);
    } else {
        initGlobalNav();
    }

    function initGlobalNav() {
        // Schutz vor bestehenden Styles
        document.body.style.paddingTop = '0';
        document.documentElement.style.scrollPaddingTop = '0';

        // Theme Switcher Initialization
        initThemeSwitcher();

        // Language Switcher Initialization
        initLanguageSwitcher();

        var dropdowns = document.querySelectorAll('.global-nav-dropdown');

        dropdowns.forEach(function(dropdown) {
            var toggle = dropdown.querySelector('.global-nav-dropdown-toggle');
            var menu = dropdown.querySelector('.global-nav-dropdown-menu');

            // Smart Positioning für Dropdowns
            function positionDropdown() {
                var rect = dropdown.getBoundingClientRect();
                var menuRect = menu.getBoundingClientRect();
                var viewportHeight = window.innerHeight;
                var viewportWidth = window.innerWidth;

                // Reset classes
                dropdown.classList.remove('flip-up', 'flip-right');

                // Check if dropdown would go below viewport
                if (rect.bottom + menuRect.height + 16 > viewportHeight) {
                    dropdown.classList.add('flip-up');
                }

                // Check if dropdown would go beyond right edge
                if (rect.left + menuRect.width > viewportWidth) {
                    dropdown.classList.add('flip-right');
                }
            }

            // Click Handler mit Smart Positioning
            toggle.addEventListener('click', function(e) {
                e.stopPropagation();

                // Andere Dropdowns schließen
                dropdowns.forEach(function(other) {
                    if (other !== dropdown) {
                        other.classList.remove('active');
                        other.querySelector('.global-nav-dropdown-toggle').setAttribute('aria-expanded', 'false');
                    }
                });

                // Position berechnen bevor Toggle
                if (!dropdown.classList.contains('active')) {
                    positionDropdown();
                }

                // Aktuelles Dropdown togglen
                var isActive = dropdown.classList.toggle('active');
                toggle.setAttribute('aria-expanded', isActive);
            });

            // Keyboard Navigation
            toggle.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggle.click();
                }
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    dropdown.classList.add('active');
                    toggle.setAttribute('aria-expanded', 'true');
                    var firstItem = menu.querySelector('.global-nav-dropdown-item');
                    if (firstItem) firstItem.focus();
                }
            });

            // Menu Item Navigation
            var items = menu.querySelectorAll('.global-nav-dropdown-item');
            items.forEach(function(item, index) {
                item.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        var nextItem = items[index + 1] || items[0];
                        nextItem.focus();
                    }
                    if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        var prevItem = items[index - 1] || items[items.length - 1];
                        prevItem.focus();
                    }
                    if (e.key === 'Escape') {
                        dropdown.classList.remove('active');
                        toggle.setAttribute('aria-expanded', 'false');
                        toggle.focus();
                    }
                });
            });
        });

        // Resize Handler für Dropdown Repositioning
        window.addEventListener('resize', function() {
            dropdowns.forEach(function(dropdown) {
                if (dropdown.classList.contains('active')) {
                    dropdown.classList.remove('flip-up', 'flip-right');
                }
            });
        });

        // Scroll Handler für Dropdown-Schließung bei Scroll
        var scrollTimeout;
        window.addEventListener('scroll', function() {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(function() {
                dropdowns.forEach(function(dropdown) {
                    dropdown.classList.remove('active');
                    dropdown.querySelector('.global-nav-dropdown-toggle').setAttribute('aria-expanded', 'false');
                });
            }, 150);
        });

        // Dropdowns schließen beim Klick außerhalb
        document.addEventListener('click', function() {
            dropdowns.forEach(function(dropdown) {
                dropdown.classList.remove('active');
                dropdown.querySelector('.global-nav-dropdown-toggle').setAttribute('aria-expanded', 'false');
            });
        });

        // ESC-Taste Handler
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                dropdowns.forEach(function(dropdown) {
                    dropdown.classList.remove('active');
                    dropdown.querySelector('.global-nav-dropdown-toggle').setAttribute('aria-expanded', 'false');
                });
            }
        });
    }

    function initThemeSwitcher() {
        var themeToggle = document.querySelector('.global-nav-theme-toggle');
        if (!themeToggle) return;

        // Gespeichertes Theme laden oder System-Präferenz nutzen
        function getPreferredTheme() {
            var stored = localStorage.getItem('theme');
            if (stored) return stored;
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);

            // Event dispatchen, damit Vue-Apps und lokale Tool-Navs reagieren können
            window.dispatchEvent(new CustomEvent('theme-changed', { detail: { theme: theme } }));
        }

        // Initiales Theme setzen
        applyTheme(getPreferredTheme());

        // Toggle Click
        themeToggle.addEventListener('click', function() {
            var current = document.documentElement.getAttribute('data-theme');
            applyTheme(current === 'dark' ? 'light' : 'dark');
        });

        // System-Präferenz-Änderungen mitverfolgen (nur wenn kein manuelles Theme gesetzt)
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
            if (!localStorage.getItem('theme')) {
                applyTheme(e.matches ? 'dark' : 'light');
            }
        });
    }

    function initLanguageSwitcher() {
        var langBtns = document.querySelectorAll('.global-nav-lang-btn');
        if (!langBtns.length) return;

        // Aktuelle Sprache aus localStorage lesen (Standard: 'de')
        var currentLang = localStorage.getItem('locale') || 'de';
        document.documentElement.setAttribute('lang', currentLang);

        // Aktiven Button markieren
        function updateActiveButton(lang) {
            langBtns.forEach(function(btn) {
                var btnLang = btn.getAttribute('data-lang');
                if (btnLang === lang) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        updateActiveButton(currentLang);

        // Initiale Navigation übersetzen
        translateNav(currentLang);

        // Click Handler
        langBtns.forEach(function(btn) {
            btn.addEventListener('click', function() {
                var targetLang = this.getAttribute('data-lang');
                var storedLang = localStorage.getItem('locale') || 'de';
                if (targetLang === storedLang) return;

                // Sprache in localStorage speichern
                localStorage.setItem('locale', targetLang);
                document.documentElement.setAttribute('lang', targetLang);

                // Button-Status aktualisieren
                updateActiveButton(targetLang);

                // Navigation sofort übersetzen
                translateNav(targetLang);

                // Event dispatchen, damit Vue-i18n die neue Sprache direkt übernimmt
                window.dispatchEvent(new CustomEvent('language-changed', { detail: { lang: targetLang } }));
            });
        });
    }
})();
</script>
