# ========== ULTIMATIVER MUSIKPLAYER (Astro Hybrid – statisch + Vue Island) ==========
#
# Ersetzt den alten SPA-Block (Port 9010). Kein Backend mehr noetig.
#
# Deployment:
#   1. npm run build
#   2. rsync -a --delete dist/ultimativer-musikplayer/ /var/www/kodinitools.com/ultimativer-musikplayer/
#   3. nginx -t && systemctl reload nginx
#
# Build-Output (selbststaendig nach Post-Build-Schritt):
#   dist/ultimativer-musikplayer/
#     index.html                  <- Landingpage (statisch, SEO)
#     app/index.html              <- Player-App (Vue Island, client:only)
#     _astro/*.js, *.css          <- Fingerprinted Assets (immutable)
#     sw.js                       <- Service Worker

# --- 301-Redirect: alter Pfad (ohne Bindestrich) -> neuer Pfad ---
location = /ultimativermusikplayer {
    return 301 /ultimativer-musikplayer/;
}
location ^~ /ultimativermusikplayer/ {
    rewrite ^/ultimativermusikplayer(/.*)?$ /ultimativer-musikplayer$1 permanent;
}

# --- Fingerprinted Astro-Assets: 1 Jahr immutable Cache ---
location ^~ /ultimativer-musikplayer/_astro/ {
    root /var/www/kodinitools.com;
    expires 1y;
    add_header Cache-Control          "public, immutable"  always;
    add_header Cross-Origin-Opener-Policy   "same-origin"  always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Resource-Policy "same-origin"  always;
    access_log off;
}

# --- Haupt-Location: statische Astro-Seiten mit SSI ---
location ^~ /ultimativer-musikplayer/ {
    root /var/www/kodinitools.com;
    index index.html;

    # SSI fuer nav.html, footer.html, cookie-banner.html
    ssi on;
    ssi_silent_errors off;

    # Statische Dateien – kein SPA-Fallback
    try_files $uri $uri/ $uri/index.html =404;

    # Cross-Origin-Headers fuer Web Audio API
    add_header Cross-Origin-Opener-Policy   "same-origin"  always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Resource-Policy "same-origin"  always;
}
