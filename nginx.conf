# ========== ULTIMATIVER MUSIKPLAYER (Astro Hybrid â€“ statisch + Vue Island) ==========
#
# Deployment:
#   1. npm run build
#   2. rsync -a dist/ultimativer-musikplayer/ /var/www/kodinitools.com/ultimativer-musikplayer/
#
# Build-Output (nach Post-Build-Schritt in package.json):
#   dist/ultimativer-musikplayer/
#     index.html                  <- Landingpage (statisch, SEO)
#     app/index.html              <- Player-App (Vue Island, client:only)
#     _astro/*.js, *.css          <- Fingerprinted Assets (immutable cache)
#     sw.js                       <- Service Worker

# 301-Redirect vom alten Pfad (ohne Bindestrich) zum neuen
location ^~ /ultimativermusikplayer/ {
    rewrite ^/ultimativermusikplayer/(.*)$ /ultimativer-musikplayer/$1 permanent;
}
location = /ultimativermusikplayer {
    return 301 /ultimativer-musikplayer/;
}

# Haupt-Location: Statische Astro-Seiten mit SSI
location ^~ /ultimativer-musikplayer/ {
    alias /var/www/kodinitools.com/ultimativer-musikplayer/;
    index index.html;

    # SSI aktivieren fuer nav.html, footer.html, cookie-banner.html
    ssi on;
    ssi_silent_errors off;

    # Statische Dateien direkt ausliefern (kein SPA-Fallback noetig)
    try_files $uri $uri/ $uri/index.html =404;

    # Cross-Origin-Headers fuer Web Audio API (AudioContext, AnalyserNode)
    add_header Cross-Origin-Opener-Policy   "same-origin"  always;
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Resource-Policy "same-origin"  always;

    # Fingerprinted Astro-Assets: aggressives Caching (1 Jahr, immutable)
    location ~* ^/ultimativer-musikplayer/_astro/ {
        alias /var/www/kodinitools.com/ultimativer-musikplayer/_astro/;
        expires 1y;
        add_header Cache-Control "public, immutable" always;
        add_header Cross-Origin-Resource-Policy "same-origin" always;
        access_log off;
    }
}
